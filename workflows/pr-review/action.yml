#
# Composite Action for PR review with Claude
#
# Usage:
#   - uses: your-org/ai-github-actions/workflows/pr-review@v1
#     with:
#       claude-oauth-token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
#       github-token: ${{ github.token }}
#
name: "Claude PR Review"
description: "Review pull requests using Claude"

branding:
  icon: "git-pull-request"
  color: "purple"

inputs:
  claude-oauth-token:
    description: "Claude OAuth token for authentication"
    required: true

  github-token:
    description: "GitHub token for Claude to operate with"
    required: true

  model:
    description: "Model to use for Claude"
    required: false
    default: "claude-sonnet-4-20250514"

  allowed-tools:
    description: "Comma-separated list of allowed tools for Claude"
    required: false
    # Note: Using ${{ github.action_path }} for the PR review scripts
    default: "Edit,MultiEdit,Glob,Grep,LS,Read,Write,WebSearch,WebFetch,mcp__github_comment__update_claude_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status:*),Bash(git diff:*),Bash(git log:*),Bash(git rm:*),Bash,mcp__agents-md-generator__generate_agents_md,mcp__agents-md-generator,mcp__public-code-search__search_code,Bash(${{ github.action_path }}/scripts/pr-comment.sh:*),Bash(${{ github.action_path }}/scripts/pr-review.sh:*),Bash(${{ github.action_path }}/scripts/pr-diff.sh:*)"

  extra-allowed-tools:
    description: "Additional comma-separated list of allowed tools (concatenated with allowed-tools)"
    required: false
    default: ""

  additional-instructions:
    description: "Additional instructions to include in the prompt"
    required: false
    default: ""

  track-progress:
    description: "Whether Claude should track progress with visual indicators"
    required: false
    default: "true"

  mcp-servers:
    description: "MCP server configuration JSON"
    required: false
    default: '{"mcpServers":{"agents-md-generator":{"type":"http","url":"https://agents-md-generator.fastmcp.app/mcp"},"public-code-search":{"type":"http","url":"https://public-code-search.fastmcp.app/mcp"}}}'

outputs:
  conclusion:
    description: "The conclusion of the Claude Code run"
    value: ${{ steps.claude.outputs.conclusion }}

runs:
  using: "composite"
  steps:
    - name: Fetch base branch for comparison
      shell: bash
      run: |
        BASE_REF="${{ github.event.pull_request.base.ref }}"
        echo "Fetching base branch: ${BASE_REF}"
        git fetch origin "${BASE_REF}:${BASE_REF}" || echo "Warning: Could not fetch base branch ${BASE_REF}"
    
    - name: Run Claude for PR Review
      id: claude
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        PR_REVIEW_REPO: ${{ github.repository }}
        PR_REVIEW_PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_REVIEW_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        PR_REVIEW_BASE_REF: ${{ github.event.pull_request.base.ref }}
        PR_REVIEW_COMMENTS_FILE: /tmp/pr-review-comments.json
        PR_SCRIPTS: ${{ github.action_path }}/scripts
      uses: anthropics/claude-code-action@v1
      with:
        claude_code_oauth_token: ${{ inputs.claude-oauth-token }}
        github_token: ${{ inputs.github-token }}
        track_progress: ${{ inputs.track-progress }}
        prompt: |
          <context>
          Repository: ${{ github.repository }}
          PR Number: #${{ github.event.pull_request.number }}
          PR Title: ${{ github.event.pull_request.title }}
          PR Author: ${{ github.event.pull_request.user.login }}
          Base Branch: ${{ github.event.pull_request.base.ref }}
          Head Branch: ${{ github.event.pull_request.head.ref }}
          </context>

          <pr_description>
          ${{ github.event.pull_request.body }}
          </pr_description>

          <task>
          Review this pull request. Focus on identifying concrete issues that require action.
          Be concise, specific, and actionable. Avoid verbose explanations or praise.
          </task>

          <getting_started>
          Use `mcp__agents-md-generator__generate_agents_md` to get repository context before reviewing.
          Use `$PR_SCRIPTS/pr-diff.sh` to see changed files, then review each file's diff.
          The base branch (`${{ github.event.pull_request.base.ref }}`) is available locally for `git diff` comparisons.
          </getting_started>

          <severity_classification>
          Classify each finding by severity:

          ðŸ”´ CRITICAL - Must fix before merge
             Security vulnerabilities, data corruption risk, production-breaking bugs
             Confidence: 95-100%

          ðŸŸ  HIGH - Should fix before merge  
             Logic errors, missing validation on critical paths, significant performance issues
             Confidence: 85-94%

          ðŸŸ¡ MEDIUM - Address soon (non-blocking)
             Error handling gaps, suboptimal patterns, missing edge cases
             Confidence: 70-84%

          âšª LOW - Author discretion (non-blocking)
             Minor improvements, documentation suggestions, style preferences not covered by linters
             Confidence: Below 70%
          </severity_classification>

          <review_criteria>
          Focus your review on these categories, in priority order:

          1. Security vulnerabilities (injection, XSS, auth bypass, secrets exposure)
          2. Logic bugs that could cause runtime failures or incorrect behavior
          3. Data integrity issues (race conditions, missing transactions, corruption risk)
          4. Performance bottlenecks (N+1 queries, memory leaks, blocking operations)
          5. Error handling gaps (unhandled exceptions, missing validation)
          6. Breaking changes to public APIs without migration path
          7. Missing or incorrect test coverage for critical paths
          </review_criteria>

          <filtering_rules>
          Do NOT flag:
          - Issues in unchanged code (only review the diff)
          - Style preferences handled by linters (formatting, semicolons, indentation)
          - Subjective nitpicks without security/correctness implications
          - Code patterns that are intentional based on surrounding context
          - Pre-existing issues not introduced by this PR
          </filtering_rules>

          <review_process>
          1. Get repository context with `mcp__agents-md-generator__generate_agents_md`
          2. List changed files with `$PR_SCRIPTS/pr-diff.sh`
          3. For each file, review the diff and identify issues matching review_criteria
          4. For each issue found:
             - Determine severity using severity_classification
             - Verify it's not filtered by filtering_rules
             - Add inline comment with `$PR_SCRIPTS/pr-comment.sh`
          5. Submit review with `$PR_SCRIPTS/pr-review.sh`
          </review_process>

          <comment_format>
          Structure each inline comment as:

          **[SEVERITY]** Brief issue description

          Why: One sentence explaining the risk or impact.

          Suggested fix: (if applicable)
          ```suggestion
          corrected code here
          ```

          Example:
          **ðŸ”´ CRITICAL** SQL injection vulnerability in user input

          Why: User-provided `id` is concatenated directly into SQL query without sanitization.

          ```suggestion
          cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
          ```
          </comment_format>

          <review_decision>
          Based on findings, choose the appropriate review action:

          - REQUEST_CHANGES: If any ðŸ”´ CRITICAL or ðŸŸ  HIGH issues found
          - COMMENT: If only ðŸŸ¡ MEDIUM or âšª LOW issues found
          - APPROVE: If no issues found or only trivial improvements suggested

          Keep the review summary concise - the inline comments contain the details.
          </review_decision>

          <tools>
          View changed files:
          ```bash
          $PR_SCRIPTS/pr-diff.sh
          ```

          View specific file diff:
          ```bash
          $PR_SCRIPTS/pr-diff.sh path/to/file.go
          ```

          Add inline comment (use line number from new file):
          ```bash
          $PR_SCRIPTS/pr-comment.sh <file> <line> "<comment>"
          ```

          Submit review:
          ```bash
          $PR_SCRIPTS/pr-review.sh <APPROVE|REQUEST_CHANGES|COMMENT> "<summary>

          ---
          *Review by Claude Code*"
          ```
          </tools>

          <additional_instructions>
          ${{ inputs.additional-instructions }}
          </additional_instructions>
        claude_args: |
          ${{ format('--allowedTools {0}{1}', inputs.allowed-tools, inputs.extra-allowed-tools != '' && format(',{0}', inputs.extra-allowed-tools) || '') }}
          --mcp-config "${{ inputs.mcp-servers }}"
          --model ${{ inputs.model }}
