#
# Composite Action for PR review with Claude (Read-Only)
#
# Usage:
#   - uses: elastic/ai-github-actions/workflows/pr-review/ro@v0
#     with:
#       claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
#       github-token: ${{ github.token }}
#
name: "Claude PR Review (Read-Only)"
description: "Review pull requests using Claude (read-only, comments only)"

branding:
  icon: "git-pull-request"
  color: "blue"

inputs:
  claude-oauth-token:
    description: "Claude OAuth token for authentication"
    required: true

  github-token:
    description: "GitHub token for Claude to operate with"
    required: true

  model:
    description: "Model to use for Claude"
    required: false
    default: "claude-opus-4-5-20251101"

  allowed-tools:
    description: "Comma-separated list of allowed tools for Claude"
    required: false
    # Note: Using ${{ github.action_path }}/../scripts for the shared PR review scripts
    default: "Glob,Grep,LS,Read,WebSearch,WebFetch,mcp__github_comment__update_claude_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,Bash(git status:*),Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(git tag:*),mcp__agents-md-generator__generate_agents_md,mcp__public-code-search__search_code,Bash(${{ github.action_path }}/../scripts/pr-comment.sh:*),Bash(${{ github.action_path }}/../scripts/pr-remove-comment.sh:*),Bash(${{ github.action_path }}/../scripts/pr-review.sh:*),Bash(${{ github.action_path }}/../scripts/pr-diff.sh:*)"

  extra-allowed-tools:
    description: "Additional comma-separated list of allowed tools (concatenated with allowed-tools)"
    required: false
    default: ""

  additional-instructions:
    description: "Additional instructions to include in the prompt"
    required: false
    default: ""

  track-progress:
    description: "Whether Claude should track progress with visual indicators"
    required: false
    default: "false"

  mcp-servers:
    description: "MCP server configuration JSON"
    required: false
    default: '{"mcpServers":{"agents-md-generator":{"type":"http","url":"https://agents-md-generator.fastmcp.app/mcp"},"public-code-search":{"type":"http","url":"https://public-code-search.fastmcp.app/mcp"}}}'

outputs:
  conclusion:
    description: "The conclusion of the Claude Code run"
    value: ${{ steps.claude.outputs.conclusion }}

runs:
  using: "composite"
  steps:
    - name: React to PR with eyes
      shell: bash
      run: |
        gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/reactions" \
          -f content=eyes 2>/dev/null || true
      env:
        GH_TOKEN: ${{ inputs.github-token }}

    - name: Run Claude for PR Review (Read-Only)
      id: claude
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        PR_REVIEW_REPO: ${{ github.repository }}
        PR_REVIEW_PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_REVIEW_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        PR_REVIEW_COMMENTS_DIR: /tmp/pr-review-comments
        PR_REVIEW_HELPERS_DIR: ${{ github.action_path }}/../scripts
      uses: elastic/ai-github-claude-code-action@working-forks
      with:
        claude_code_oauth_token: ${{ inputs.claude-oauth-token }}
        github_token: ${{ inputs.github-token }}
        track_progress: ${{ inputs.track-progress }}
        prompt: |
          <context>
          Repository: ${{ github.repository }}
          PR Number: #${{ github.event.pull_request.number }}
          PR Title: ${{ github.event.pull_request.title }}
          PR Author: ${{ github.event.pull_request.user.login }}
          Branch: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}
          
          **Note**: The PR head branch has already been checked out. The workspace is ready for review - you can immediately start reviewing files and diffs.
          </context>

          <pr_description>
          ${{ github.event.pull_request.body }}
          </pr_description>

          <task>
          Review this pull request and provide feedback via GitHub PR review comments.
          Focus on identifying concrete issues that require action.
          Be concise, specific, and actionable. Avoid verbose explanations or praise.
          
          Use inline comments (pr-comment.sh) for line-specific issues with concrete fixes.
          Put broader architectural concerns in the review body when submitting.
          </task>

          <constraints>
          This workflow is for review and comments ONLY - feedback is provided via GitHub PR review comments.
          
          You CANNOT: Modify files locally, run tests, execute commands, create branches, commit code, push changes
          You CAN: Read/analyze code, review diffs, provide code suggestions (via ```suggestion blocks in comments)
          
          **Important**: Your feedback is provided via GitHub PR review comments, not by making local code changes.
          Suggestion blocks let PR authors apply your fixes with one click.
          </constraints>

          <allowed_tools>
          You have access to the following tools (comma-separated list):
          
          ${{ inputs.allowed-tools }}
          ${{ inputs.extra-allowed-tools }}
          
          You can only use tools that are explicitly listed above. For Bash commands, the pattern `Bash(command:*)` means you can run that command with any arguments. If a command is not listed, it is not available.
          </allowed_tools>

          <getting_started>
          1. Use `mcp__agents-md-generator__generate_agents_md` to get repository context
          2. Run `$PR_REVIEW_HELPERS_DIR/pr-diff.sh` to see all changed files with diffs
             - Output shows line numbers: `[LINE]` = commentable, `[----]` = deleted (can't comment)
             - For large PRs, it will list files only - review each with `pr-diff.sh <filename>`
          3. Use `Read` to see full file contents when you need more context
          </getting_started>

          <severity_classification>
          Classify each finding by severity:

          ðŸ”´ CRITICAL - Must fix before merge
             Security vulnerabilities, data corruption risk, production-breaking bugs
             Confidence: 95-100%

          ðŸŸ  HIGH - Should fix before merge  
             Logic errors, missing validation on critical paths, significant performance issues
             Confidence: 85-94%

          ðŸŸ¡ MEDIUM - Address soon (non-blocking)
             Error handling gaps, suboptimal patterns, missing edge cases
             Confidence: 70-84%

          âšª LOW - Author discretion (non-blocking)
             Minor improvements, documentation suggestions, style preferences not covered by linters
             Confidence: Below 70%

          ðŸ’¬ NITPICK - Truly optional (non-blocking)
             Stylistic preferences, alternative approaches, "consider this" suggestions
             Safe to ignore entirely
          </severity_classification>

          <review_criteria>
          Focus your review on these categories, in priority order:

          1. Security vulnerabilities (injection, XSS, auth bypass, secrets exposure)
          2. Logic bugs that could cause runtime failures or incorrect behavior
          3. Data integrity issues (race conditions, missing transactions, corruption risk)
          4. Performance bottlenecks (N+1 queries, memory leaks, blocking operations)
          5. Error handling gaps (unhandled exceptions, missing validation)
          6. Breaking changes to public APIs without migration path
          7. Missing or incorrect test coverage for critical paths
          </review_criteria>

          <filtering_rules>
          Do NOT flag:
          - Issues in unchanged code (only review the diff)
          - Style preferences handled by linters (formatting, semicolons, indentation)
          - Subjective nitpicks without security/correctness implications
          - Code patterns that are intentional based on surrounding context
          - Pre-existing issues not introduced by this PR
          </filtering_rules>

          <review_process>
          1. Get repository context with `mcp__agents-md-generator__generate_agents_md`
          2. Run `$PR_REVIEW_HELPERS_DIR/pr-diff.sh` to see changed files with line-numbered diffs
          3. For each file, review the diff and identify issues matching review_criteria
          4. For each issue found:
             - Determine severity using severity_classification
             - Verify it's not filtered by filtering_rules
             - Use the `[LINE]` number from the diff output for pr-comment.sh
             - Provide --severity, --title, --why, and suggestion code via heredoc
             - Use --no-suggestion only for issues requiring multi-location fixes
          5. Submit review with `$PR_REVIEW_HELPERS_DIR/pr-review.sh`, including broader architectural
             concerns in the review body (not as inline comments)
          </review_process>

          <comment_format>
          The pr-comment.sh script assembles comments in a consistent format. You provide:
          - --severity: critical, high, medium, low, nitpick
          - --title: Brief description for the comment heading
          - --why: One sentence explaining the risk/impact
          - Suggestion code via stdin (heredoc) - or --no-suggestion for architectural issues

          **Always provide suggestions** for line-specific issues. Use --no-suggestion only when
          the fix requires changes across multiple locations. Larger architectural concerns
          belong in the review body, not inline comments.
          </comment_format>

          <review_decision>
          Based on findings, choose the appropriate review action:

          - REQUEST_CHANGES: If any ðŸ”´ CRITICAL or ðŸŸ  HIGH issues found
          - COMMENT: If ðŸŸ¡ MEDIUM issues found (but no critical/high)
          - APPROVE: If no issues, or only âšª LOW / ðŸ’¬ NITPICK suggestions

          **Important**: The review body is your main output. Include:
          - Any broader architectural concerns not suited for inline comments
          - Critical issues identified that are outside the scope of the PR diff but are impacted by the PR
          - Your recommendation (approve/request changes/comment) with rationale
          - Avoid summarizing the PR, providing general feedback or explanations of changes
          - Avoid offering praise for the author, PR, or team.
          - If your recommendation is APPROVE and there are no issues, do not provide a review-body to just 
            leave an approval.

          The inline comments provide line-specific details; the review body ties it together.
          </review_decision>

          <tools>
          View changed files:
          ```bash
          $PR_REVIEW_HELPERS_DIR/pr-diff.sh
          ```

          View specific file diff:
          ```bash
          $PR_REVIEW_HELPERS_DIR/pr-diff.sh path/to/file.go
          ```

          Add inline comment with suggestion (preferred):
          ```bash
          $PR_REVIEW_HELPERS_DIR/pr-comment.sh <file> <line> \
            --severity <critical|high|medium|low|nitpick> \
            --title "Brief description" \
            --why "Risk or impact" <<'EOF'
          corrected code here
          EOF
          ```

          Add inline comment without suggestion (for architectural issues only):
          ```bash
          $PR_REVIEW_HELPERS_DIR/pr-comment.sh <file> <line> \
            --severity <critical|high|medium|low|nitpick> \
            --title "Brief description" \
            --why "Risk or impact" \
            --no-suggestion
          ```

          Remove a queued comment (if you made a mistake):
          ```bash
          $PR_REVIEW_HELPERS_DIR/pr-remove-comment.sh <file> <line>
          ```

          Submit review (include broader concerns in the summary):
          ```bash
          $PR_REVIEW_HELPERS_DIR/pr-review.sh <APPROVE|REQUEST_CHANGES|COMMENT> "<summary>"
          ```
          
          Note: A standard footer is automatically appended to all comments and reviews.
          </tools>

          <additional_instructions>
          ${{ inputs.additional-instructions }}
          </additional_instructions>
        claude_args: |
          ${{ format('--allowedTools {0}{1}', inputs.allowed-tools, inputs.extra-allowed-tools != '' && format(',{0}', inputs.extra-allowed-tools) || '') }}
          --mcp-config '${{ inputs.mcp-servers }}'
          --model ${{ inputs.model }}
