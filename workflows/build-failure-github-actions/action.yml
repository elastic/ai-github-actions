#
# Composite Action for analyzing GitHub Actions build failures with Claude
#
# Usage:
#   - uses: your-org/ai-github-actions/workflows/build-failure-github-actions@v1
#     with:
#       claude-oauth-token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
#       github-token: ${{ github.token }}
#
name: "Claude GitHub Actions Build Failure Analysis"
description: "Analyze GitHub Actions workflow failures and suggest fixes using Claude"

branding:
  icon: "alert-triangle"
  color: "red"

inputs:
  claude-oauth-token:
    description: "Claude OAuth token for authentication"
    required: true

  github-token:
    description: "GitHub token for Claude to operate with"
    required: true

  model:
    description: "Model to use for Claude"
    required: false
    default: "claude-sonnet-4-20250514"

  allowed-tools:
    description: "Comma-separated list of allowed tools for Claude"
    required: false
    default: "Edit,MultiEdit,Glob,Grep,LS,Read,Write,WebSearch,WebFetch,mcp__github_comment__update_claude_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status:*),Bash(git diff:*),Bash(git log:*),Bash(git rm:*),Bash,mcp__agents-md-generator__generate_agents_md,mcp__agents-md-generator,mcp__public-code-search__search_code"

  extra-allowed-tools:
    description: "Additional comma-separated list of allowed tools (concatenated with allowed-tools)"
    required: false
    default: ""

  additional-instructions:
    description: "Additional instructions to include in the prompt"
    required: false
    default: ""

  track-progress:
    description: "Whether Claude should track progress with visual indicators"
    required: false
    default: "true"

  mcp-servers:
    description: "MCP server configuration JSON"
    required: false
    default: '{"mcpServers":{"agents-md-generator":{"type":"http","url":"https://agents-md-generator.fastmcp.app/mcp"},"public-code-search":{"type":"http","url":"https://public-code-search.fastmcp.app/mcp"}}}'

outputs:
  conclusion:
    description: "The conclusion of the Claude Code run"
    value: ${{ steps.claude.outputs.conclusion }}

runs:
  using: "composite"
  steps:
    - name: Run Claude for GitHub Actions Build Failure Analysis
      id: claude
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      uses: anthropics/claude-code-action@v1
      with:
        claude_code_oauth_token: ${{ inputs.claude-oauth-token }}
        github_token: ${{ inputs.github-token }}
        track_progress: ${{ inputs.track-progress }}
        prompt: |
          ## GitHub Context
          - Repository: ${{ github.repository }}
          - Event: ${{ github.event_name }}
          - Branch: ${{ github.event.workflow_run.head_branch || github.head_ref || github.ref_name }}
          - Commit SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
          ${{ github.event.workflow_run.name && format('- Failed Workflow: {0}', github.event.workflow_run.name) || '' }}
          ${{ github.event.workflow_run.id && format('- Workflow Run ID: {0}', github.event.workflow_run.id) || '' }}
          ${{ github.event.workflow_run.html_url && format('- Workflow URL: {0}', github.event.workflow_run.html_url) || '' }}

          ## Instructions
          
          ### Getting Started
          **First, get repository context**: Use the `mcp__agents-md-generator__generate_agents_md` tool to generate a repository summary. This will give you essential context about the codebase structure, technologies used, and project conventions. Call this tool at the start of your investigation.

          **If you encounter any issues using tools** (e.g., tool not found, permission errors, API failures), mention this in your response with a link to the support channel: https://elastic.slack.com/archives/C0AAMNAA89M

          ### Investigation Approach
          **Be extremely thorough in your investigations**. Don't rush to conclusions. Take time to:
          - Understand the full context of the repository
          - Review all relevant code, build configurations, and test files
          - Analyze error messages and stack traces completely
          - Consider all possible root causes and edge cases
          - Gather comprehensive information before suggesting fixes
          
          **Available tools for investigation**:
          - **`mcp__github_ci__get_ci_status`**: Get the status of CI workflows for this repository
          - **`mcp__github_ci__get_workflow_run_details`**: Get detailed information about a specific workflow run
          - **`mcp__github_ci__download_job_log`**: Download logs from failed jobs
          - **`mcp__public-code-search__search_code`**: Use this to search for code patterns in OTHER repositories (external libraries, modules, or dependencies). The current repository is cloned locally, so use `Grep` or `Read` for searching within this repo. Use `search_code` for finding similar error patterns in other projects, checking library documentation, or understanding how other repositories handle similar build issues.
          - **`WebSearch`**: Use for searching the web for error messages, build failures, or solutions to specific CI/CD problems.
          - **`WebFetch`**: Use to fetch and read content from URLs (documentation, error logs, API references, etc.).

          A GitHub Actions workflow has failed. Please analyze the failure and help fix it.

          ### GitHub Actions Analysis Workflow

          #### Step 1: Get workflow run details
          Use `mcp__github_ci__get_workflow_run_details` with the workflow run ID to see:
          - Which jobs failed
          - The status of each job
          - Links to job logs

          #### Step 2: Download failed job logs
          For each failed job, use `mcp__github_ci__download_job_log` to retrieve the full logs. Look for:
          - Error messages
          - Stack traces
          - Test failures
          - Build errors

          #### Step 3: Analyze the workflow file
          Review the workflow YAML file (`.github/workflows/*.yml`) to understand:
          - What the workflow is trying to do
          - Which steps are failing
          - Dependencies between jobs
          - Environment setup requirements

          ### Analysis Steps
          1. **Identify failed jobs/steps** - Determine exactly what failed in the workflow
          2. **Extract error messages** - Find the specific error messages and stack traces from the logs
          3. **Identify root cause** - Determine what caused the failure (code bug, test failure, dependency issue, infrastructure problem, workflow configuration issue, etc.)
          4. **Analyze the code** - Look at the relevant source files in this repository
          5. **Review workflow configuration** - Check if the workflow YAML has any issues
          6. **Suggest fixes** - Provide specific, actionable suggestions to resolve the issue

          ### Response Format
          Post a comment summarizing:
          - **Workflow**: Link to the failed workflow run
          - **What failed**: Which job(s)/step(s) failed
          - **Error message**: The key error message(s) from the logs
          - **Root cause**: What caused the failure
          - **Recommended fix**: Specific steps to resolve the issue
          - **Code changes**: If applicable, show the exact code changes needed
          - **Workflow changes**: If the issue is in the workflow configuration, suggest workflow YAML changes

          Focus on being helpful and specific. If the fix is straightforward, explain exactly what needs to change.

          ## Response Footer
          Always end your comment with this footer (using markdown):
          ```
          ---
          *Comment by Claude Code* | üöÄ if perfect, üëç if helpful, üëé if not | Type `@claude` to interact further
          ```

          ${{ inputs.additional-instructions }}
        claude_args: |
          ${{ format('--allowedTools {0}{1}', inputs.allowed-tools, inputs.extra-allowed-tools != '' && format(',{0}', inputs.extra-allowed-tools) || '') }}
          --mcp-config "${{ inputs.mcp-servers }}"
          --model ${{ inputs.model }}
