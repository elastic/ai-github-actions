#
# Composite Action for responding to @claude mentions on Pull Requests
#
# Usage:
#   - uses: your-org/ai-github-actions/workflows/mention-pr@v1
#     with:
#       claude-oauth-token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}
#       github-token: ${{ github.token }}
#
name: "Claude Mention Response (PR)"
description: "Respond when Claude is mentioned in PR comments"

branding:
  icon: "git-pull-request"
  color: "orange"

inputs:
  claude-oauth-token:
    description: "Claude OAuth token for authentication"
    required: true

  github-token:
    description: "GitHub token for Claude to operate with"
    required: true

  model:
    description: "Model to use for Claude"
    required: false
    default: "claude-sonnet-4-20250514"

  allowed-tools:
    description: "Comma-separated list of allowed tools for Claude"
    required: false
    # Includes PR review thread scripts
    default: "Edit,MultiEdit,Glob,Grep,LS,Read,Write,WebSearch,WebFetch,mcp__github_comment__update_claude_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status:*),Bash(git diff:*),Bash(git log:*),Bash(git rm:*),Bash,mcp__agents-md-generator__generate_agents_md,mcp__agents-md-generator,mcp__public-code-search__search_code,Bash(${{ github.action_path }}/scripts/gh-get-review-threads.sh:*),Bash(${{ github.action_path }}/scripts/gh-resolve-review-thread.sh:*),Bash(${{ github.action_path }}/scripts/gh-minimize-outdated-comments.sh:*)"

  extra-allowed-tools:
    description: "Additional comma-separated list of allowed tools (concatenated with allowed-tools)"
    required: false
    default: ""

  additional-instructions:
    description: "Additional instructions to include in the prompt"
    required: false
    default: ""

  track-progress:
    description: "Whether Claude should track progress with visual indicators"
    required: false
    default: "true"

  mcp-servers:
    description: "MCP server configuration JSON"
    required: false
    default: '{"mcpServers":{"agents-md-generator":{"type":"http","url":"https://agents-md-generator.fastmcp.app/mcp"},"public-code-search":{"type":"http","url":"https://public-code-search.fastmcp.app/mcp"}}}'

outputs:
  conclusion:
    description: "The conclusion of the Claude Code run"
    value: ${{ steps.claude.outputs.conclusion }}

runs:
  using: "composite"
  steps:
    - name: Run Claude for PR Mention
      id: claude
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        # For PR review thread scripts
        MENTION_REPO: ${{ github.repository }}
        MENTION_PR_NUMBER: ${{ github.event.issue.number }}
        MENTION_SCRIPTS: ${{ github.action_path }}/scripts
      uses: anthropics/claude-code-action@v1
      with:
        claude_code_oauth_token: ${{ inputs.claude-oauth-token }}
        github_token: ${{ inputs.github-token }}
        track_progress: ${{ inputs.track-progress }}
        prompt: |
          ## GitHub Context
          - Repository: ${{ github.repository }}
          - PR Number: #${{ github.event.issue.number }}
          - PR Title: ${{ github.event.issue.title }}
          - PR Author: ${{ github.event.issue.user.login }}
          - Comment Author: ${{ github.event.comment.user.login }}
          - Comment Body:
          ```
          ${{ github.event.comment.body }}
          ```

          ## Instructions
          
          ### Getting Started
          **First, get repository context**: Use the `mcp__agents-md-generator__generate_agents_md` tool to generate a repository summary. This will give you essential context about the codebase structure, technologies used, and project conventions. Call this tool at the start of your investigation.

          **If you encounter any issues using tools** (e.g., tool not found, permission errors, API failures), mention this in your response with a link to the support channel: https://elastic.slack.com/archives/C0AAMNAA89M

          ### Investigation Approach
          **Be extremely thorough in your investigations**. Don't rush to conclusions. Take time to:
          - Understand the full context of the repository
          - Review related code, issues, and PRs
          - Consider edge cases and implications
          - Gather all relevant information before responding

          **Available tools for investigation**:
          - **`mcp__public-code-search__search_code`**: Use this to search for code patterns in OTHER repositories (external libraries, modules, or dependencies). The current repository is cloned locally, so use `Grep` or `Read` for searching within this repo. Use `search_code` for finding similar implementations in other projects or understanding how other repositories handle similar issues.
          - **`WebSearch`**: Use for searching the web for documentation, best practices, or solutions.
          - **`WebFetch`**: Use to fetch and read content from URLs (documentation, API references, etc.).

          You have been mentioned in a **Pull Request** comment. Please:

          1. **Read the request** - Understand what is being asked in the comment above
          2. **Gather context** - Review the PR changes, review threads, and relevant code
          3. **Complete the task** - Do what is requested to the best of your ability
          4. **Respond** - Post a comment with your response or results

          ### Common tasks on PRs:
          - Address review feedback and fix issues
          - Answer questions about the changes
          - Make additional code changes
          - Resolve review threads after fixing

          If the request is unclear, ask clarifying questions.
          If the request requires actions you cannot perform, explain what you can and cannot do.

          ## PR Review Thread Tools

          You have access to scripts for managing review threads.

          ### View unresolved review threads
          ```bash
          $MENTION_SCRIPTS/gh-get-review-threads.sh
          ```
          This shows all review threads with their resolution status, file paths, line numbers, and comments.
          
          To filter for unresolved threads from a specific reviewer:
          ```bash
          $MENTION_SCRIPTS/gh-get-review-threads.sh "reviewer-username"
          ```

          ### Resolve a review thread
          After addressing feedback, resolve the thread:
          ```bash
          $MENTION_SCRIPTS/gh-resolve-review-thread.sh "THREAD_ID" "Fixed by updating the error handling"
          ```
          - `THREAD_ID` is the GraphQL node ID from the review threads output (e.g., `PRRT_kwDOABC123`)
          - The comment is optional - use it to explain what you did
          - If all threads from a review are resolved, the review is automatically minimized

          ### Clean up outdated comments
          Keep only the most recent comment from each author visible:
          ```bash
          $MENTION_SCRIPTS/gh-minimize-outdated-comments.sh
          ```
          This helps reduce noise on busy PRs.

          ### Typical workflow when asked to address review feedback:
          1. Run `$MENTION_SCRIPTS/gh-get-review-threads.sh` to see what needs addressing
          2. Make the requested code changes
          3. Commit and push the changes
          4. Resolve each addressed thread with `$MENTION_SCRIPTS/gh-resolve-review-thread.sh`

          ## Response Footer
          Always end your comment with this footer (using markdown):
          ```
          ---
          *Comment by Claude Code* | üöÄ if perfect, üëç if helpful, üëé if not | Type `@claude` to interact further
          ```

          ${{ inputs.additional-instructions }}
        claude_args: |
          ${{ format('--allowedTools {0}{1}', inputs.allowed-tools, inputs.extra-allowed-tools != '' && format(',{0}', inputs.extra-allowed-tools) || '') }}
          --mcp-config "${{ inputs.mcp-servers }}"
          --model ${{ inputs.model }}
